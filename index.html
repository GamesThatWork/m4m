<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello World</title>
    <script src="pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/PixiPlugin.min.js"></script>
  </head>
  <body>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    </style>




<script type="module">

const app = new PIXI.Application({width:1920, height:1080});
document.body.appendChild(app.view);
const canvas = document.querySelector("canvas");
let eq   =new PIXI.Sprite.from( '/assets/equation.png');
    //eq.width *=0.8;
    //eq.height*=0.8;
    eq.visible=false;
    eq.position.set(60,180);
    app.stage.addChild( eq )

let chart =new PIXI.Container();
    chart.position.set(12,460);
    app.stage.addChild( chart )
let map =new PIXI.Sprite.from( '/assets/map.png');
    map.position.set(1020,0);
    app.stage.addChild( map )



//********************* test the linechart ****************
   
import  { newLineChart } from './linechart.js';
 



let wavelength=25;
let tZero=0;

const shockwave= (n, count=500)=>{
  let buf =[];
  for( let x=0; x<count; x++) 
    buf[x]=  
        x<n+wavelength?  Math.sin( ((0 + (n-x))/wavelength ) *Math.PI)  / (n**2-n*x)
    :      0

  return buf;
}

  // experimental power equations -- no joy  
  //   1/(n-x) * -Math.sin(((x-n)*2    )*Math.PI/50)  
  //    x<n? /* (x)       **4  / n**4   * */ -Math.sin((x-n)*2*Math.PI/50)  
  // :  x<n*2? /* (2*n-x)  **77  / n**77  * */ -Math.sin((x-n)*2*Math.PI/50) 
  //  :  0;


var synch=false, extra=false;


const g = newLineChart (  {  parent:chart, data: null,
                        x:{  min:0.1, max:500,   px:1000}, 
                        y:{  min:-.00081, max:.005,  px:500}, 
                          });

//g.dragReport(        e=> console.log(e) );

var plot=false;
app.ticker.add( t=> {
  if( plot ){
    let n = Math.floor( ((Date.now()-tZero)/4) %500 );
    if (n<5)  g.reset();
    g.plot( shockwave( n )); 
    }
  });

function trackit( e ){
//  console.log( e.data.getLocalPosition(e.target) );
  let p= e.data.getLocalPosition(e.target);
  let x= (p.x-37)/923;
  if( x<0 || x>1) return;
  console.log( x, p);
  g.plot( shockwave(x * 500) )
  if( synch ) outer( x*111+50);
  if( extra ) inner( x*111+50);
}



 document.addEventListener('keydown', e=>{
  console.log( e.code );
  switch(e.code){
    case 'KeyG':
      g.show();
      break; 
    case 'KeyP':
      tZero=Date.now();
      g.reset();
      plot=!plot;
      break; 
      case 'KeyB':
      g.bounds();
      break; 
    case 'KeyT':
      let h = g.hitBox;
      h.interactive=h.interactiveChildren=true;
      console.log("HITBOX", h);
      h.on("mousemove", trackit);
      break; 
      case 'KeyE':
//      g.equation();
      eq.visible=!eq.visible;
      break; 
    case 'KeyR':
//      g.equation();
      g.reset();
      break; 
      case 'KeyS':
        synch=!synch;
        extra=false;
        g.reset();
        break; 
      case 'KeyX':
        extra=!extra;
        synch=false;
        g.reset();
        break; 
    }
});





 
/****
let cb = e=>{
 //   console.log(  "pointermove", e);
    }

h.on('pointerdown',     e=> {
  plot=false;
  g.bounds().reset();
  h.on( 'pointermove', cb );
  });


h.on('pointerup',       e=> h.off('pointermove', cb ));
h.on('pointerupoutside',e=> h.off('pointermove', cb ));

****/


//********************* test the reticle ********************
import  { newReticle } from './reticle.js';
map.interactive=true;



const ret = {  parent:map, 
               min:{radius:50,heat:1}, 
               max:{radius:70,heat:1}
                }

var r = newReticle( ret  ).move(map.width/2,map.height/2)
                          .show();

function track(e){
  let p = e.data.getLocalPosition( map );
//  console.log(p);
  r.move( p.x, p.y);
  }

  function outer( rad ) {
  console.log( rad);
  rad*=1;
  if( ret.max.radius==rad  ) return;
  ret.max.radius=rad; 
  r.destruct();
  r = newReticle( ret  ).move(map.width/2,map.height/2)
                          .show();
}


function inner( rad ) {
  console.log( rad);
  rad*=1;
  if( ret.min.radius==rad  ) return;
      ret.min.radius= rad; 
  r.destruct();
  r = newReticle( ret  ).move(map.width/2,map.height/2)
                          .show();
}





map.on("mouseout", e=>{
  gsap.to(   r, {x:map.width/2, y:map.height/2, duration: .5, ease: "elastic.out(1.1, 0.2 )"} );
  map.off("mousemove", track);
  });
map.on("mouseover", e=> {
  gsap.from( r, {immediacy:0, duration:1, ease: "linear"});
  map.on("mousemove", track);
  });
/*
    map.addEventListener("mousemove", e=> r.move(e.clientX, e.clientY) );
map.addEventListener("mouseleave",e=> 
    gsap.to(r, {x:map.width/2, y:map.height/2, duration: .5, ease: "elastic.out(1.1, 0.2 )"}));
map.addEventListener("mouseenter",e=> 
    gsap.from( r, {immediacy:0, duration:1, ease: "linear"}));
*/
    </script>
  </body>
</html>*